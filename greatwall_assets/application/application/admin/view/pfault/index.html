{extend name="admin@public/base_content" /}{block name="body">}<body>{include file="admin@public/common" /}<div class="layui-form">    <table class="layui-table lay-even">        <thead>        <tr>            <th>ID</th>            <th>模板ID</th>            <th>创建时间</th>            <!--<th>预约发送时间</th>-->            <th>发送状态</th>            <th>发送对象</th>            <th>操作</th>        </tr>        </thead>        <tbody>        {foreach name="list" item="vo"}        <tr>            <td align="center"><span>{$vo.id}</span></td>            <td>{$vo.template_id}</td>            <td>{$vo.createtime|date="Y-m-d H:i:s"}</td>            <!--<td>{$vo.sendtime}</td>-->            <td id="num{$vo.id}">{$vo.status*100}%</td>            <td>{$vo.tagname}</td>            <td>                <a href="{:url('priview',array('id'=>$vo.id))}" class="layui-btn layui-btn-mini modal-catch">                    <i class="iconfont">&#xe653;</i>预览                </a>                <a href="{:url('add',array('id'=>$vo.id))}" class="layui-btn layui-btn-mini modal-catch">                    <i class="iconfont">&#xe653;</i>修改                </a>                <a href="javascript:void(0);" onclick="selectsend('{$vo.tagid}','{$vo.id}',0)" class="layui-btn layui-btn-mini modal-catch">                    <i class="iconfont">&#xe653;</i>筛选对象                </a>                <a href="javascript:void(0);" onclick="send('{$vo.tagid}','{$vo.id}',0)"  class="layui-btn layui-btn-mini modal-catch">                    <i class="iconfont">&#xe653;</i>发送                </a>                <a class="layui-btn layui-btn-mini layui-btn-danger ajax"                   data-list='{"key":"id={$vo.id}","msg":true,"render":"true","action":"del"}'                   data-params='{"url": "{:url("pfault/del")}","confirm":"true","data":"id={$vo.id}","complete":"del"}'>                    <i class="iconfont">&#xe626;</i>删除                </a>            </td>        </tr>        {/foreach}        </tbody>    </table></div><div class="text-right">    <div class="layui-box layui-laypage layui-laypage-molv" id="layui-laypage-1">        {$list|raw}    </div></div></body>{/block}{block name="script"}<script src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><script>    function send(tagid,id,limit) {        $.ajax({            url:"{:url('pfault/nowsend')}",            type:"post",            data:{                'limit':limit,                'tagid':tagid,                'id':id,            },            dataType:"json",            success:function (data) {                if(data.status==1){                    $('#num'+data.msg.id).text(data.msg.num+'%');                    limit=limit+100;                    send(tagid,id,limit);                }else if(data.status==1){                    $('#num'.data.msg.id).text('100%');                    alert('全部发送完毕');return;                }else if(data.status==2){                    alert('此标签不能直接发送，请先筛选');                }else{                    alert('发送中断');                }            }        })    }    function selectsend(tagid,id,limit) {        $.ajax({            url:"{:url('pfault/selectsend')}",            type:"post",            data:{                'limit':limit,                'tagid':tagid,                'id':id,            },            dataType:"json",            success:function (data) {                if(data.status==1){                    $('#num'+data.msg.id).text(data.msg.num+'%');                    limit=limit+100;                    selectsend(tagid,id,limit);                }else if(data.status==2){                    alert('此标签不能筛选');return;                }else if(data.status==3){                    alert('不能重复筛选');                }else if(data.status==0){                    alert('筛选中断');                }else if(data.status==200){                    alert('筛选完毕');return;                }            }        })    }    layui.use('default');</script>{/block}