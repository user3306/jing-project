<?php/** * Created by PhpStorm. * User: dingzq * Date: 2018/3/18 * Time: 9:40 */namespace app\admin\controller;use org\weixin\Wechat;use think\Db;class Wxuser extends Admin{    /**     * 当前模块参数     */    protected function _infoModule(){        return array(            'info'  => array(                'name' => '会员管理',                'description' => '会员管理',            ),            'menu' => array(                array(                    'name' => '会员管理',                    'url' => url('index'),                    'icon' => 'list',                ),            ),            '_info' => array(            ),        );    }    /**     * 列表     */    public function index(){        //筛选条件        $where = array();//        $mobile = input('mobile');////        if(!empty($mobile))////        {////            $where[]=['mobile','=',$mobile];////        }        $nickname = base64_encode(input('nickname'));        if(!empty($nickname)){            $where[] = ['nickname','like','%'.$nickname.'%'];            $where[] = ['subscribe','=',1];        }        //查询数据        $limit=20;        $list = model('Wxuser')->loadList($where,$limit);        //位置导航        $breadCrumb = array('会员管理'=>url());        //模板传值        $this->assign('breadCrumb',$breadCrumb);        $this->assign('list',$list);        $this->assign('_page',$list->render());        return $this->fetch();    }        public function info()    {        $id = input('id');        //$pfault = model('XzyPfault');        if (input('post.')) {            $openid = input('post.openid');            $realname = input('post.realname');            $cardcode = input('post.cardcode');            $mobile = input('post.mobile');            $uinfo = Db::name('wxuser')->where('id',$id)->find();            if($uinfo['mobile']!=$mobile){                //改变了手机号，积分和卡券都要修改为新的手机号                //修改卡券                Db::name('xzy_cardgetrecord')->where('mobile',$uinfo['mobile'])->update(array('mobile'=>$mobile));                //修改积分                Db::name('xzy_userpoints')->where('mobile',$uinfo['mobile'])->update(array('mobile'=>$mobile));            }            Db::name('wxuser')->where('id',$id)->update(array('realname'=>$realname,'mobile'=>$mobile,'cardcode'=>$cardcode));                       return ajaxReturn(200,'操作成功',url('index'));        }else{            $uinfo = Db::name('wxuser')->where('id',$id)->find();            $this->assign('info',$uinfo);            return $this->fetch();        }    }    public function putcard()    {        $id = input('id');        //$pfault = model('XzyPfault');        if (input('post.')) {            dump($_POST);die;            $openid = input('post.openid');            $card_id = input('post.card_id');            $cryptstr = md5('dzq'.$card_id.$openid);            $r1 = date('YmdHis');            $r2 = rand(100000,999999);            //$r3 = rand(100000,999999);            //存入redis 5            $keys = $r1.'#'.$r2.'#'.$openid.'#'.$card_id;            $url = 'http://vip.xinziyou.com/home/index/getcard.html?card_id=' . $card_id.'&openid='.$openid.'&cryptstr=' . $cryptstr.'&keys='.$keys;            $weObj=new Wechat(get_weichat_options());            //$test = $weObj->setCardTestWhiteList(array('oUOag03qN5rjIVp_G10vEN_xpenY'));            //dump($test);            //exit;            $arr = array();            $arr['touser']=$openid;            $arr['template_id']='Nu_3ySvpF0C8JM6OYhXbXNJpFoTcaqgIz1ekkL-jIaA';            $arr['url']=$url;            $arr['data']['first']['value']='点击领取您的卡券';            $arr['data']['keyword1']['value']='卡券下发';            $arr['data']['keyword2']['value']=date('Y-m-d H:i:s');            $arr['data']['remark']['value']='领取后将放入您的卡包，再次到店面消费时请出示，谢谢。';            $res = $weObj->sendTemplateMessage($arr);            return ajaxReturn(200,'操作成功',url('index'));        }else{            $uinfo = Db::name('wxuser')->where('id',$id)->find();            $this->assign('info',$uinfo);            //找出所有优惠券            $weObj=new Wechat(get_weichat_options());            $cardlist = $weObj->getCardIdList(0,50);            //dump($cardlist);            $cardInfo = array();            foreach ($cardlist['card_id_list'] as $key=>$value)            {                if($value=='pUOag00WWLS5s1uDqNadJw4NYOBI')                    continue;                                $tmpArr = array();                $tmpArr['card_id']=$value;                $tmpcardinfo = $weObj->getCardInfo($value);                //卡券类别转小写                $cardtype = strtolower($tmpcardinfo['card']['card_type']);                //dump($tmpcardinfo['card'][$cardtype]['base_info']['title']);                $tmpArr['card_name']=$tmpcardinfo['card'][$cardtype]['base_info']['title'];                $cardInfo[] = $tmpArr;            }            //dump($cardInfo);            $this->assign('ticketsList',$cardInfo);            return $this->fetch();        }    }}